#/bin/bash

#Add myclublink user to the system
addgroup http
echo "* Adding myclublink user to system"
pass=$(perl -e 'print crypt($ARGV[0], "password")' "3enchm@rk789")
useradd -m -p $pass "myclublink" -G http  #add myclublink to http group


#Add current user to myclublink group
CURRENTUSER="`logname`"
usermod -a -G myclublink $CURRENTUSER 

#Add current user to the http group so they can have access to myclublink directories etc
sudo addgroup $CURRENTUSER http --quiet

if [[ $EUID -ne 0 ]]; then
	echo "This script needs to be run as root. Exiting .."
	exit 1
fi

#Note - Later I'll add the public ssh key to bitbucket automatically for the current machine and generate it via ssh-keygen if one not generated

echo "* Upating package sources"
#sudo apt-get update

echo "* Installing package dependencies"
for dep in git nginx htop vim samba openssh-server; do
	if dpkg -s $dep 2>/dev/null 1>/dev/null; then
		echo $dep " is installed already. Skipping "
	else
		sudo apt-get install $dep -y
	fi
done
echo "- Update done"

echo "* Setting up SSH keys .."
#Generate ssh keys for myclublink user
if [ ! -d "/home/myclublink/.ssh" ]; then
	echo "- SSH keys don't exist so I'm creating them in /home/myclublink/.ssh"
	sudo -u myclublink ssh-keygen -b 4096 -t rsa -f /home/myclublink/.ssh/id_rsa -P ""
	#this is probably bad but will do for now. Allow members of myclublink group to read from .ssh
	sudo chmod -R 750 /home/myclublink/.ssh 
	
	echo "SSH Keys have been created. Please enter them manually on BitBucket account for now"
	exit 1
else
	echo "- SSH keys already in place. I won't create them"
fi

#add the ssh public key to the bitbucket rep

#example request
#key and label have to be set in the body

#POST /api/1.0/users/bradmccormack/ssh-keys/ HTTP/1.1
#Authorization:
#Basic ****
#X-HostCommonName:
#bitbucket.org
#Host:
#bitbucket.org
#Content-Length:
#441
#X-Target-URI:
#https://bitbucket.org
#Content-Type:
#application/x-www-form-urlencoded; charset=UTF-8
#Connection:
#Keep-Alive
#key=ssh-rsa+AAAAB3NzaC1yc2EAAAADAQABAAABAQDAgLp6lc%2F9dELRalcKaDWqkXjaCykgXIa4vxR0vQdbaef4lSlNLuAro38Qs6eZSmwV1hRiM482rHfytE7KC5UNMx1dIyHblnvBRgc5Ouqun2hqFFXvtJISfmBJXNGoEx5khOVKPjlX1D8AvgmmysT%2FKl71Q%2F%2BdvDdioqcw6QuxB6GjzQS7L%2FUXYuHXhRflr0oUpDnW5D2iNQjcGDIQl8C3SxzOzO%2FVy%2B%2FM%2Fc3anBPJCClTg00a4D60yqnQZz4UTJIPzagwpaUW8ATsD8RoIp2NibYLiIN5Qgwk8A0DK4aBwxikxxgVGsgElKaUpdQoNJsNav3XE%2FsqfU7nEgMxAL8L+myclublink%40ubuntu&label=testingAPI
#RequestResponseView raw Share

#example response
#HTTP/1.1 200 OK
#Content-Language:
#en
#ETag:
#"fe1719adac8c02a6015289a32951c53e"
#X-Render-Time:
#0.461893081665
#Content-Length:
#460
#X-Served-By:
#bitbucket16
#X-Version:
#734bd9b293af
#X-Request-Count:
#257
#Server:
#nginx/1.2.4
#X-Content-Type-Options:
#nosniff
#Strict-Transport-Security:
#max-age=2592000
#Date:
#Fri, 07 Jun 2013 07:59:27 GMT
#Vary:
#Authorization, Accept-Language, Cookie
#X-Static-Version:
#0c9e84a522b5
#Content-Type:
#application/json; charset=utf-8
#{
#  "pk": 741340,
#  "key": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDAgLp6lc/9dELRalcKaDWqkXjaCykgXIa4vxR0vQdbaef4lSlNLuAro38Qs6eZSmwV1hRiM482rHfytE7KC5UNMx1dIyHblnvBRgc5Ouqun2hqFFXvtJISfmBJXNGoEx5khOVKPjlX1D8AvgmmysT/Kl71Q/+dvDdioqcw6QuxB6GjzQS7L/UXYuHXhRflr0oUpDnW5D2iNQjcGDIQl8C3SxzOzO/Vy+/M/c3anBPJCClTg00a4D60yqnQZz4UTJIPzagwpaUW8ATsD8RoIp2NibYLiIN5Qgwk8A0DK4aBwxikxxgVGsgElKaUpdQoNJsNav3XE/sqfU7nEgMxAL8L myclublink@ubuntu",
#  "label": "testingAPI"
#}


#delete the current config file if one is there
if [ -f $HOME/.ssh/config ]; then
	sudo rm $HOME/.ssh/config
fi

#Silence the nagging of security prompt and set the identity to use for ssh
sudo echo "Host bitbucket.org" >> $HOME/.ssh/config 
sudo echo "StrictHostKeyChecking no" >> $HOME/.ssh/config
sudo echo "IdentityFile /home/myclublink/.ssh/id_rsa.pub" >> $HOME/.ssh/config


#Create git directory for myclublink user ready to download if it doesn't exist
if [ ! -d "/home/myclublink/git" ]; then
	sudo -u myclublink mkdir -p /home/myclublink/git
	sudo chmod 775 /home/myclublink/git
fi

cd /home/myclublink/git/
if [ -d "myclublink" ]; then
	echo "- myclublink repo already exists. Pulling latest code"
	sudo -u myclublink git clean -f --quiet
        sudo -u myclublink git pull --quiet
else
	echo "- Cloning repository"
	git clone git@bitbucket.org:bradmccormack/myclublink.git --quiet
fi

echo "- Code pulled down."

if [ -d "/etc/nginx" ]; then
	echo "* Nginx config being deployed and web server being restarted"
	#create symbolic links that point back to this config. Later it will be trivial to run this script and have updated web server configurations
	
	#only create if they don't exist
	if [ ! -L /etc/nginx/sites-available/internal.myClubLink.com.au.conf ]; then
		sudo ln -s /home/myclublink/git/myclublink/Conf/nginx/internal.myClubLink.com.au.conf /etc/nginx/sites-available/internal.myClubLink.com.au.conf
	fi

	if [ ! -L /etc/nginx/sites-enabled/internal.myClubLink.com.au.conf ]; then
		sudo ln -s /home/myclublink/git/myclublink/Conf/nginx/internal.myClubLink.com.au.conf /etc/nginx/sites-enabled/internal.myClubLink.com.au.conf
	fi
	sudo rm /etc/nginx/sites-enabled/default -f
else
	echo "- Nginx didn't install correctly before. Aborting script!"
	exit 1
fi

#create a file share for the installer - TODO put this in a chroot
if [ ! "/etc/samba" ]; then
	echo "- Samba didn't install correctly. Aborting script!"
else
	#hose the default one and link to our versioned one and add the curent user to samba
	sudo rm /etc/samba/smb.conf -f
	sudo ln -s /home/myclublink/git/myclublink/Conf/samba/smb.conf /etc/samba/smb.conf
	(echo myclublink; echo myclublink) | smbpasswd -s 2>/dev/null 1>/dev/null
	sudo service smbd restart --quiet
	sudo service nmbd restart --quiet
fi

sudo service nginx restart --quiet

ip=`ifconfig eth0 | grep 'inet addr:' | cut -d: -f2 | awk '{ print $1}'`
echo "myClubLink is now running . Hit it on"  $ip "or add it to the host file of the user or DNS server for the users on the local network"
